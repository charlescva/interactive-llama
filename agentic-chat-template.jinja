{# ----------------------------- #
# Agentic tool-use chat template #
# Llama 3.x style headers        #
# ----------------------------- #}

{{- bos_token -}}

{# -------- Utilities / defaults -------- #}
{%- if not date_string is defined -%}
  {%- if strftime_now is defined -%}
    {%- set date_string = strftime_now("%Y-%m-%d") -%}
  {%- else -%}
    {%- set date_string = "2025-11-18" -%}
  {%- endif -%}
{%- endif -%}

{# By default, put tool schemas into the first user turn (often improves tool-calling reliability) #}
{%- if not tools_in_user_message is defined -%}
  {%- set tools_in_user_message = true -%}
{%- endif -%}

{%- if not tools is defined -%}
  {%- set tools = none -%}
{%- endif -%}

{# -------- Extract (optional) leading system message -------- #}
{%- if messages|length > 0 and messages[0]['role'] == 'system' -%}
  {%- set system_message = messages[0]['content']|trim -%}
  {%- set messages = messages[1:] -%}
{%- else -%}
  {%- set system_message = "" -%}
{%- endif -%}

{# -------- System header -------- #}
<|start_header_id|>system<|end_header_id|>

You are an autonomous AI agent. Follow the **Tool Use Rules** provided by the system and the conversation context. 
Knowledge cutoff: {{ knowledge_cutoff if knowledge_cutoff is defined else "2023-12" }}
Current date: {{ date_string }}

{{- "\n\n" -}}
{{- system_message -}}
<|eot_id|>

{# -------- Option A: Put tool specs inside the first user turn -------- #}
{%- if tools is not none and tools_in_user_message %}
  {%- if messages|length == 0 -%}
    {{- raise_exception("tools_in_user_message=true requires at least one user message") -}}
  {%- endif -%}
  {%- set first_user = messages[0]['content']|trim -%}
  {%- set messages   = messages[1:] -%}

  <|start_header_id|>user<|end_header_id|>

  You have access to the following **tools**. 
  When you decide to call a tool, **respond ONLY** with a JSON object (no prose) in the form:
  {"name": "<tool_name>", "arguments": { ... }}

  Tools:
  {%- for t in tools %}
  {{ t | tojson(indent=2) }}
  {%- if not loop.last %}

  {%- endif -%}
  {%- endfor %}

  {{- "\n\n" -}}
  {{- first_user -}}
  <|eot_id|>

{# -------- Option B: Put tool specs into an additional system turn -------- #}
{%- elif tools is not none and not tools_in_user_message %}
  <|start_header_id|>system<|end_header_id|>

  The following **tools** are available. 
  When you decide to call a tool, **respond ONLY** with a JSON object (no prose) in the form:
  {"name": "<tool_name>", "arguments": { ... }}

  Tools:
  {%- for t in tools %}
  {{ t | tojson(indent=2) }}
  {%- if not loop.last %}

  {%- endif -%}
  {%- endfor %}
  <|eot_id|>
{%- endif %}

{# -------- Remaining transcript -------- #}
{%- for message in messages %}
  {%- if message['role'] == 'user' %}
    <|start_header_id|>user<|end_header_id|>

    {{- message['content']|trim -}}
    <|eot_id|>
  {%- elif message['role'] == 'assistant' %}
    <|start_header_id|>assistant<|end_header_id|>

    {# Assistant can contain normal text or previously emitted tool_calls; render both if present #}
    {{- message['content']|default("")|trim -}}
    {%- if message['tool_calls'] is defined and message['tool_calls']|length > 0 -%}
{{ message['tool_calls'] | tojson(indent=2) }}
    {%- endif -%}
    <|eot_id|>
  {%- elif message['role'] in ['tool', 'ipython'] %}
    {# Standardize tool results so the model can ground on them #}
    <|start_header_id|>tool<|end_header_id|>

    { 
      "tool_call_id": "{{ message.get('tool_call_id', '') }}",
      "name": "{{ message.get('name', '') }}",
      "result": {{ message['content'] | tojson }}
    }
    <|eot_id|>
  {%- elif message['role'] == 'system' %}
    {# If a later system message appears, pass it through as-is #}
    <|start_header_id|>system<|end_header_id|>

    {{- message['content']|trim -}}
    <|eot_id|>
  {%- endif %}
{%- endfor %}

{# -------- Generation cue: start next assistant turn -------- #}
<|start_header_id|>assistant<|end_header_id|>
